<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>net.lewisship.test-pipeline documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">io.github.hlship/test-pipeline</span> <span class="project-version">v0.1</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1 current"><a href="net.lewisship.test-pipeline.html"><div class="inner"><span>net.lewisship.test-pipeline</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="net.lewisship.test-pipeline.html#var-add-halt-check"><div class="inner"><span>add-halt-check</span></div></a></li><li class="depth-1"><a href="net.lewisship.test-pipeline.html#var-assoc-in-context"><div class="inner"><span>assoc-in-context</span></div></a></li><li class="depth-1"><a href="net.lewisship.test-pipeline.html#var-calls"><div class="inner"><span>calls</span></div></a></li><li class="depth-1"><a href="net.lewisship.test-pipeline.html#var-capture-logging"><div class="inner"><span>capture-logging</span></div></a></li><li class="depth-1"><a href="net.lewisship.test-pipeline.html#var-continue"><div class="inner"><span>continue</span></div></a></li><li class="depth-1"><a href="net.lewisship.test-pipeline.html#var-execute"><div class="inner"><span>execute</span></div></a></li><li class="depth-1"><a href="net.lewisship.test-pipeline.html#var-halt"><div class="inner"><span>halt</span></div></a></li><li class="depth-1"><a href="net.lewisship.test-pipeline.html#var-halt-on-failure"><div class="inner"><span>halt-on-failure</span></div></a></li><li class="depth-1"><a href="net.lewisship.test-pipeline.html#var-log-events"><div class="inner"><span>log-events</span></div></a></li><li class="depth-1"><a href="net.lewisship.test-pipeline.html#var-mock"><div class="inner"><span>mock</span></div></a></li><li class="depth-1"><a href="net.lewisship.test-pipeline.html#var-reporting"><div class="inner"><span>reporting</span></div></a></li><li class="depth-1"><a href="net.lewisship.test-pipeline.html#var-split"><div class="inner"><span>split</span></div></a></li><li class="depth-1"><a href="net.lewisship.test-pipeline.html#var-spy"><div class="inner"><span>spy</span></div></a></li><li class="depth-1"><a href="net.lewisship.test-pipeline.html#var-update-in-context"><div class="inner"><span>update-in-context</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">net.lewisship.test-pipeline</h1><div class="doc"><div class="markdown"><p>Per-test pipeline of composable steps, including simple mocks and capturing of logging events.</p>
<p>A test is implemented as series of step functions; each step receives a context map, does work, and passes the (sometimes modified) context map to the next step.</p>
<p>The goal is to make tests flatter (fewer nested scopes), more readable, and to make various kinds of steps more composable.</p>
</div></div><div class="public anchor" id="var-add-halt-check"><h3>add-halt-check</h3><div class="usage"><code>(add-halt-check context check-fn)</code></div><div class="doc"><div class="markdown"><p>Adds a halt check function to the context, for use by <a href="net.lewisship.test-pipeline.html#var-continue">continue</a>.</p>
<p>Returns the updated context, which should then be passed to <code>continue</code>.</p>
</div></div><div class="src-link"><a href="https://github.com/hlship/test-pipeline/blob/master/src/net/lewisship/test_pipeline.clj#L40">view source</a></div></div><div class="public anchor" id="var-assoc-in-context"><h3>assoc-in-context</h3><div class="usage"><code>(assoc-in-context ks v)</code></div><div class="doc"><div class="markdown"><p>Returns a step function that performs an <code>assoc-in</code> on the context during execution.</p>
</div></div><div class="src-link"><a href="https://github.com/hlship/test-pipeline/blob/master/src/net/lewisship/test_pipeline.clj#L118">view source</a></div></div><div class="public anchor" id="var-calls"><h3>calls</h3><h4 class="type">macro</h4><div class="usage"><code>(calls context spy-var)</code></div><div class="doc"><div class="markdown"><p>Returns calls to-date of the given spy, clearing the list of calls as a side effect.</p>
</div></div><div class="src-link"><a href="https://github.com/hlship/test-pipeline/blob/master/src/net/lewisship/test_pipeline.clj#L156">view source</a></div></div><div class="public anchor" id="var-capture-logging"><h3>capture-logging</h3><div class="usage"><code>(capture-logging context)</code></div><div class="doc"><div class="markdown"><p>A step function that captures logging events from <code>clojure.tools.logging</code>.</p>
<p>Replaces the <code>*logger-factory*</code> with one that enables logging for all loggers and levels, and captures all log events to an atom. These events can be accessed via <a href="net.lewisship.test-pipeline.html#var-log-events">log-events</a>.</p>
<p>Each captured logging event is a map with the following keys:</p>
<ul>
<li>:thread-name - String name of current thread</li>
<li>:logger - String name of logger, e.g., “com.example.myapp.worker”</li>
<li>:level - keyword of log level (:debug, :error, etc.)</li>
<li>:throwable - instance of Throwable, or nil</li>
<li>:message - String message</li>
</ul>
<p>Note that only logging events from <code>clojure.tools.logging</code> are captured; logging to other frameworks (such logging from referenced Java libraries) are logged normally and not captured.</p>
</div></div><div class="src-link"><a href="https://github.com/hlship/test-pipeline/blob/master/src/net/lewisship/test_pipeline.clj#L187">view source</a></div></div><div class="public anchor" id="var-continue"><h3>continue</h3><div class="usage"><code>(continue context)</code></div><div class="doc"><div class="markdown"><p>Called from a step function to pass the context to the next step function in the pipeline. Does nothing if there are no more steps to execute.</p>
<p>continue is responsible for halt checks; each added halt check function is passed the context, and if any of them return a truthy value, the pipeline is halted, as with <a href="net.lewisship.test-pipeline.html#var-halt">halt</a>.</p>
</div></div><div class="src-link"><a href="https://github.com/hlship/test-pipeline/blob/master/src/net/lewisship/test_pipeline.clj#L49">view source</a></div></div><div class="public anchor" id="var-execute"><h3>execute</h3><div class="usage"><code>(execute &amp; step-fns)</code></div><div class="doc"><div class="markdown"><p>The main entrypoint: executes a sequence of step functions as a pipeline.</p>
<p>A step function is responsible for one portion of setting up the test environment, and may perform part of the test execution as well. Generally, the final step function is the most specific to a particular test, and will be where most assertions occur.</p>
<p>A step function is passed a context; the step function’s job is to modify the context before passing the context to <code>continue</code>; this call is often wrapped in a <code>try</code> (to clean up resources) and/or <code>with-redefs</code> (to override functions for testing).</p>
<p>Note that nils are allowed as no-op steps to make it easier to conditionally include steps using <code>when</code>.  The provided seq of step functions is flattened and nils are removed before constructing the final pipeline.</p>
<p>Each step function must call <a href="net.lewisship.test-pipeline.html#var-continue">continue</a> (except the final step function, for which the call to <code>continue</code> is optional and does nothing); however this check is skipped if the execution pipeline is halted.</p>
</div></div><div class="src-link"><a href="https://github.com/hlship/test-pipeline/blob/master/src/net/lewisship/test_pipeline.clj#L72">view source</a></div></div><div class="public anchor" id="var-halt"><h3>halt</h3><div class="usage"><code>(halt context)</code></div><div class="doc"><div class="markdown"><p>Called instead of <a href="net.lewisship.test-pipeline.html#var-continue">continue</a> to immediately halt the execution of the pipeline without executing any further steps. This is used when an error has been detected that will invalidate behavior checks in later steps.</p>
<p>When execution is halted, the check that ensures all steps executed is disabled.</p>
</div></div><div class="src-link"><a href="https://github.com/hlship/test-pipeline/blob/master/src/net/lewisship/test_pipeline.clj#L31">view source</a></div></div><div class="public anchor" id="var-halt-on-failure"><h3>halt-on-failure</h3><div class="usage"><code>(halt-on-failure context)</code></div><div class="doc"><div class="markdown"><p>Adds a halt check that terminates the pipeline if any test errors or test failures are subsequently reported.</p>
</div></div><div class="src-link"><a href="https://github.com/hlship/test-pipeline/blob/master/src/net/lewisship/test_pipeline.clj#L63">view source</a></div></div><div class="public anchor" id="var-log-events"><h3>log-events</h3><div class="usage"><code>(log-events context)</code></div><div class="doc"><div class="markdown"><p>Returns all captured logging events, while clearing the list as a side effect.</p>
</div></div><div class="src-link"><a href="https://github.com/hlship/test-pipeline/blob/master/src/net/lewisship/test_pipeline.clj#L210">view source</a></div></div><div class="public anchor" id="var-mock"><h3>mock</h3><h4 class="type">macro</h4><div class="usage"><code>(mock mock-var mock-fn)</code></div><div class="doc"><div class="markdown"><p>Expands to a step function that mocks the var with the corresponding function (as with <code>clojure.core/with-redefs</code>).</p>
</div></div><div class="src-link"><a href="https://github.com/hlship/test-pipeline/blob/master/src/net/lewisship/test_pipeline.clj#L124">view source</a></div></div><div class="public anchor" id="var-reporting"><h3>reporting</h3><h4 class="type">macro</h4><div class="usage"><code>(reporting k)</code></div><div class="doc"><div class="markdown"><p>Expands to a step function based on <code>com.walmartlabs.test-reporting/reporting</code> that extracts a value from the context and reports its value if a test fails.</p>
</div></div><div class="src-link"><a href="https://github.com/hlship/test-pipeline/blob/master/src/net/lewisship/test_pipeline.clj#L166">view source</a></div></div><div class="public anchor" id="var-split"><h3>split</h3><div class="usage"><code>(split step-fns)</code></div><div class="doc"><div class="markdown"><p>Splits the execution pipeline.  Returns a step function that will sequence through the provided seq of step fns and pass the context to each in turn.</p>
<p>Thus, any steps further down the pipeline will be invoked multiple times.</p>
</div></div><div class="src-link"><a href="https://github.com/hlship/test-pipeline/blob/master/src/net/lewisship/test_pipeline.clj#L175">view source</a></div></div><div class="public anchor" id="var-spy"><h3>spy</h3><h4 class="type">macro</h4><div class="usage"><code>(spy spy-var)</code><code>(spy spy-var mock-fn)</code></div><div class="doc"><div class="markdown"><p>Expands to a step function that mocks a function with a spy.</p>
<p>The spy records into an atom each set of arguments it is passed, before passing the arguments to the spied function.</p>
<p>Optionally, a mock function (as with <a href="net.lewisship.test-pipeline.html#var-mock">mock</a>) can be supplied to replace the spied function.</p>
<p>Usage:</p>
<pre><code>  (spy db/put-row (fn [_ row-data] ...))
</code></pre>
<p>The <a href="net.lewisship.test-pipeline.html#var-calls">calls</a> macro retrieves the calls made to the spy.</p>
</div></div><div class="src-link"><a href="https://github.com/hlship/test-pipeline/blob/master/src/net/lewisship/test_pipeline.clj#L132">view source</a></div></div><div class="public anchor" id="var-update-in-context"><h3>update-in-context</h3><div class="usage"><code>(update-in-context ks f &amp; args)</code></div><div class="doc"><div class="markdown"><p>Returns a step function that performs an <code>update-in</code> on the context during execution.</p>
</div></div><div class="src-link"><a href="https://github.com/hlship/test-pipeline/blob/master/src/net/lewisship/test_pipeline.clj#L112">view source</a></div></div></div></body></html>